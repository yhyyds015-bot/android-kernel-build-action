name: Build AArch64 GKI Kernel Module (from code/)
on:
  workflow_dispatch:
    inputs:
      kernel_tag:
        description: 'Android Kernel Tag (e.g., android13-5.15, android16-6.12)'
        required: true
        default: 'android13-5.15'
        type: choice
        options:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12
      module_name:
        description: 'Kernel Module Name (must match code/[module_name].c)'
        required: true
        default: 'mydriver'

jobs:
  build-module:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (含 code 目录)
        uses: actions/checkout@v4.2.2

      - name: 检查并准备模块目录（关键修复）
        shell: bash
        run: |
          MODULE_NAME="${{ github.event.inputs.module_name }}"
          # 1. 校验 code 目录文件
          REQUIRED_FILES=("code/${MODULE_NAME}.c" "code/Makefile")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ 缺失必需文件: $file"
              exit 1
            fi
          done
          # 2. 提前创建模块目录并复制文件（确保 Action 执行时目录存在）
          mkdir -p "$MODULE_NAME"
          cp code/*.c code/Makefile "$MODULE_NAME/"
          echo "✅ 模块目录创建完成：$MODULE_NAME"
          ls -al "$MODULE_NAME/"

      - name: 调用 GKI 模块构建 Action
        uses: ./  # 本地 Action 路径
        with:
          tag: ${{ github.event.inputs.kernel_tag }}
          arch: aarch64
          module-name: ${{ github.event.inputs.module_name }}

      - name: 查看构建产物
        shell: bash
        run: |
          if [ -d "./output" ]; then
            echo "构建产物列表："
            ls -al ./output/
          else
            echo "⚠️ 未找到 output 目录，可能构建失败"
          fi
