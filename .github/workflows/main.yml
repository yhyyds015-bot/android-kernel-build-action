name: Build AArch64 GKI Kernel Module (from code/)
on:
  workflow_dispatch:  # 手动触发构建
    inputs:
      kernel_tag:
        description: 'Android Kernel Tag (e.g., android13-5.15, android16-6.12)'
        required: true
        default: 'android13-5.15'
        type: choice
        options:
          - android12-5.10
          - android13-5.10
          - android13-5.15
          - android14-5.15
          - android14-6.1
          - android15-6.6
          - android16-6.12
      module_name:
        description: 'Kernel Module Name (must match code/[module_name].c)'
        required: true
        default: 'mydriver'  # 替换为你的模块名

jobs:
  build-module:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (含 code 目录)
        uses: actions/checkout@v4.2.2

      - name: 检查 code 目录文件规范
        shell: bash
        run: |
          MODULE_NAME="${{ github.event.inputs.module_name }}"
          echo "正在校验 code 目录下文件是否符合要求..."
          
          # 校验必需文件存在
          REQUIRED_FILES=(
            "code/${MODULE_NAME}.c"  # 模块核心源码
            "code/Makefile"          # 模块编译脚本
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ 缺失必需文件: $file"
              exit 1
            fi
          done
          
          # 校验 Makefile 基础配置（可选，增强兼容性）
          if ! grep -q "obj-m += ${MODULE_NAME}.o" "code/Makefile"; then
            echo "⚠️ code/Makefile 未发现 'obj-m += ${MODULE_NAME}.o'，自动添加..."
            echo -e "\nobj-m += ${MODULE_NAME}.o" >> "code/Makefile"
          fi
          
          echo "✅ 文件规范校验通过！"

      - name: 调用 GKI 模块构建 Action
        uses: ./  # 本地 Action（若 Action 已发布到 GitHub，替换为 "你的用户名/仓库名@版本"）
        with:
          tag: ${{ github.event.inputs.kernel_tag }}
          arch: aarch64  # 固定为 aarch64，与 Action 要求一致
          module-name: ${{ github.event.inputs.module_name }}

      - name: 查看构建产物
        shell: bash
        run: |
          echo "构建产物列表："
          ls -al ./output/
